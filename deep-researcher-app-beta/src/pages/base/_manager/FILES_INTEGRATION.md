# Files API Integration

This document describes the integration of the backend Files API into the frontend Files management UI.

## Overview

The Files tab now connects to the backend API (`/api/files`) to manage files stored in the `bucket/` folder and tracked in `bucket/bucket.sqlite3`. This replaces the previous mock data implementation.

## Files Changed

### New Files

1. **`src/lib/filesApi.js`** - New API client module
   - Follows the same pattern as `researchApi.js`
   - Provides functions to interact with all Files API endpoints
   - Handles data normalization and formatting
   - Base URL: `http://localhost:8000`

### Updated Files

1. **`src/pages/base/_manager/File.jsx`** - Category file view

   - Integrated real API calls
   - Added loading and error states
   - Connected delete, download, and view handlers
   - Enhanced filtering to support downloaded files
   - Added toast notifications for user feedback

2. **`src/pages/base/_manager/Files.jsx`** - Main files overview

   - Integrated real API calls
   - Added loading and error states
   - Connected file action handlers
   - Dynamic file statistics
   - Real-time data refresh

3. **`src/App.jsx`** - Root application component
   - Added `Toaster` component from sonner for notifications

## API Functions

All functions are exported from `src/lib/filesApi.js`:

### Core Functions

- **`fetchFiles(options)`** - Get list of files with filters

  - Parameters: `type`, `category`, `q`, `limit`, `offset`, `include_content`, etc.
  - Returns: `{ files: File[], count: number }`

- **`fetchFile(fileId, options)`** - Get single file details

  - Parameters: `fileId`, `include_content`, `content_mode`, `content_limit`
  - Returns: `File`

- **`uploadFiles(files, metadata)`** - Upload new files

  - Parameters: `files` (array), `metadata` (object with `chat_id`, `tags`, etc.)
  - Returns: `File[]`

- **`updateFile(fileId, updates)`** - Update file metadata

  - Parameters: `fileId`, `updates` (object with `tags`, `chat_id`, `is_active`, etc.)
  - Returns: `File`

- **`deleteFile(fileId, hard)`** - Delete file
  - Parameters: `fileId`, `hard` (boolean for hard delete)
  - Returns: `boolean`

### Utility Functions

- **`getDownloadUrl(fileId)`** - Get download URL for a file
- **`getFileUrl(type, filename)`** - Get serving URL for static files
- **`fetchFileContent(fileId, mode, limit)`** - Get file content
- **`getFileStats()`** - Get bucket-wide statistics
- **`getFileAccessStats(fileId, days)`** - Get access stats for a file
- **`searchFiles(q, options)`** - Search files
- **`syncCrawls(dryRun, maxImport)`** - Sync Crawl4AI entries

## File Object Structure

Files are normalized to a consistent format:

```javascript
{
  id: string,                  // Stable file ID
  name: string,                // Original filename
  storedFilename: string,      // Filename on disk
  size: string,                // Formatted size (e.g., "2.4 MB")
  sizeBytes: number,           // Size in bytes
  date: string,                // ISO date string (YYYY-MM-DD)
  dateCreated: string,         // Full ISO datetime
  type: string,                // MIME type
  mimeType: string,            // MIME type (same as type)
  category: string,            // documents|images|audios|videos|crawls|docs
  chat: string,                // Chat ID or "N/A"
  chatId: string|null,         // Chat ID from metadata
  user: string,                // "Uploaded by user" | "Generated by AI" | "Downloaded"
  ioTag: string,               // uploaded|generated|downloaded|unknown
  typeCategory: string,        // uploads|downloads|generated
  fileUrl: string,             // Public serving URL
  servePath: string,           // Path used by serving route
  tags: string[],              // Array of tags
  content: string,             // File content (if requested)
  contentMode: string,         // text|base64
  raw: object                  // Original API response
}
```

## Category Mapping

UI categories are mapped to API categories:

| UI Category | API Category | Description                      |
| ----------- | ------------ | -------------------------------- |
| `docs`      | `documents`  | Documents (PDF, DOCX, TXT, etc.) |
| `audio`     | `audios`     | Audio files (MP3, WAV, etc.)     |
| `images`    | `images`     | Images (PNG, JPG, etc.)          |
| `videos`    | `videos`     | Video files                      |

## Features

### File Management

- ✅ View files by category
- ✅ Search files by name, type, chat, tags
- ✅ Sort by name, date, or size
- ✅ Filter by source (AI-generated, user-uploaded, downloaded)
- ✅ Delete files (soft delete by default)
- ✅ Download files
- ⏳ Preview files (coming soon)

### User Experience

- ✅ Loading states with spinner
- ✅ Error handling with retry option
- ✅ Toast notifications for actions
- ✅ Real-time data refresh
- ✅ File statistics dashboard
- ✅ Tag display

## Usage Examples

### Load files for a category

```javascript
import { fetchFiles } from "@/lib/filesApi";

const { files, count } = await fetchFiles({
  category: "documents",
  limit: 50,
});
```

### Delete a file

```javascript
import { deleteFile } from "@/lib/filesApi";
import { toast } from "sonner";

try {
  await deleteFile(fileId);
  toast.success("File deleted successfully");
} catch (err) {
  toast.error("Failed to delete file: " + err.message);
}
```

### Download a file

```javascript
import { getDownloadUrl } from "@/lib/filesApi";

const url = getDownloadUrl(fileId);
window.open(url, "_blank");
```

### Upload files

```javascript
import { uploadFiles } from "@/lib/filesApi";

const files = [file1, file2]; // File objects from input
const metadata = {
  chat_id: "chat-123",
  tags: ["important", "document"],
};

const uploadedFiles = await uploadFiles(files, metadata);
```

## Backend Requirements

The backend must expose the following endpoints:

- `GET /api/files` - List files
- `GET /api/files/{file_id}` - Get file details
- `GET /api/files/{file_id}/download` - Download file
- `GET /api/files/{file_id}/content` - Get file content
- `POST /api/files/upload` - Upload files
- `PUT /api/files/{file_id}` - Update file metadata
- `DELETE /api/files/{file_id}` - Delete file
- `GET /api/files/stats` - Get statistics
- `GET /api/files/{file_id}/stats` - Get file access stats
- `GET /api/files/search` - Search files
- `POST /api/files/sync-crawls` - Sync Crawl4AI entries
- `GET /files/{type}/{filename}` - Serve static files

See `FILES_API.md` for full API documentation.

## Error Handling

All API calls are wrapped in try-catch blocks and display user-friendly error messages:

```javascript
try {
  await deleteFile(fileId);
  toast.success("File deleted");
} catch (err) {
  console.error("Delete failed:", err);
  toast.error("Failed to delete file: " + err.message);
}
```

## Future Enhancements

- [ ] File preview modal (images, PDFs, text files)
- [ ] Bulk file operations (delete, download, tag)
- [ ] File upload UI in Files tab
- [ ] Advanced filtering (by date range, size range)
- [ ] File sharing and permissions
- [ ] File versioning
- [ ] Drag-and-drop upload
- [ ] File thumbnails for images

## Testing

To test the integration:

1. Ensure backend is running on `http://localhost:8000`
2. Navigate to `/app/files` in the app
3. Verify files load from the API
4. Test category filtering by clicking "View All"
5. Test search functionality
6. Test sort and filter options
7. Test delete and download actions
8. Verify error handling by stopping the backend

## Notes

- The base URL is hardcoded to `http://localhost:8000` in `filesApi.js`
- File deletes are soft by default (can be changed by passing `hard: true`)
- Toast notifications require the `Toaster` component to be rendered in the app root
- File previews are not yet implemented (placeholder toast message shown)
- The API expects FormData for uploads with optional metadata fields
- Web crawls from Crawl4AI need to be synced using the `/api/files/sync-crawls` endpoint
